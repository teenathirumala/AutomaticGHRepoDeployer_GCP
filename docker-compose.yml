# Docker Compose for local development/testing
# This allows you to run all services locally before deploying to Azure

version: '3.8'

services:
  api-server:
    build:
      context: ./api-server
      dockerfile: Dockerfile
    ports:
      - "9000:9000"
      - "9002:9002"
    environment:
      - PORT=9000
      - SOCKET_PORT=9002
      - FRONTEND_ORIGIN=http://localhost:3000
      - AZURE_SUBSCRIPTION_ID=${AZURE_SUBSCRIPTION_ID}
      - AZURE_RESOURCE_GROUP=${AZURE_RESOURCE_GROUP}
      - AZURE_LOCATION=${AZURE_LOCATION:-eastus}
      - BUILDER_IMAGE=${BUILDER_IMAGE}
      - AZURE_STORAGE_ACCOUNT_NAME=${AZURE_STORAGE_ACCOUNT_NAME}
      - AZURE_BLOB_CONTAINER_NAME=${AZURE_BLOB_CONTAINER_NAME:-build-outputs}
      - REDIS_URL=${REDIS_URL}
      - PREVIEW_URL_BASE=${PREVIEW_URL_BASE:-http://localhost:8000}
    volumes:
      - ./api-server:/app
    networks:
      - vercel-clone-network

  reverse-proxy:
    build:
      context: ./s3-reverse-proxy
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - AZURE_STORAGE_ACCOUNT_NAME=${AZURE_STORAGE_ACCOUNT_NAME}
      - AZURE_BLOB_CONTAINER_NAME=${AZURE_BLOB_CONTAINER_NAME:-build-outputs}
      - AZURE_BLOB_PREFIX=${AZURE_BLOB_PREFIX:-__outputs}
    volumes:
      - ./s3-reverse-proxy:/app
    networks:
      - vercel-clone-network

  # Optional: Local Redis for testing (if not using Azure Cache)
  # redis:
  #   image: redis:7-alpine
  #   ports:
  #     - "6379:6379"
  #   networks:
  #     - vercel-clone-network

networks:
  vercel-clone-network:
    driver: bridge

